box: node:0.12

# Data sources/services
services:
  - deangiberson/aws-dynamodb-local
  - mysql/mysql-server

build:
  steps:
    - npm-install
    - script:
        name: dynamodb config
        code: |
          export MODLI_DYNAMODB_HOST=http://${AWS_DYNAMODB_LOCAL_PORT_8000_TCP_ADDR}:${AWS_DYNAMODB_LOCAL_PORT_8000_TCP_PORT}
    - script:
        name: mysql config
        code: |
          export MODLI_MYSQL_URL=WERCKER_MYSQL_URL
          export MODLI_MYSQL_DATABASE=WERCKER_MYSQL_DATABASE
          export MODLI_MYSQL_PORT=WERCKER_MYSQL_PORT
          export MODLI_MYSQL_HOST=WERCKER_MYSQL_HOST
          export MODLI_MYSQL_PASSWORD=WERCKER_MYSQL_PASSWORD
          export MODLI_MYSQL_USERNAME=WERCKER_MYSQL_USERNAME
    - script:
        name: lint code
        code: |
          make lint
    - script:
        name: run tests
        code: |
          make test
    - script:
        name: run coverage
        code: |
          make test-cover
    - script:
        name: build
        code: |
          make build
          
  after-steps:
    # Run and report coverage
    - script:
        name: send code coverage report
        code: |
          npm install -g codeclimate-test-reporter
          codeclimate-test-reporter < coverage/lcov.info
